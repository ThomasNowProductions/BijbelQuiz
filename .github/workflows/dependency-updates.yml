name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'  # Updated to support Dart SDK 3.8.0+
          cache: true

      - name: Setup Node.js for pub outdated
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check Flutter and Dart versions
        run: |
          echo "Flutter version:"
          flutter --version
          echo "Current Dart SDK version: $(dart --version)"

      - name: Check for outdated dependencies
        id: outdated
        run: |
          cd app
          echo "Checking for outdated dependencies..."
          flutter pub outdated --show-all --json > outdated.json || true

          # Check if there are any outdated packages
          if [ -s outdated.json ]; then
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            echo "Found outdated dependencies:"
            cat outdated.json | jq '.packages | keys[]' 2>/dev/null || echo "Unable to parse JSON, but file exists"
          else
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "No outdated dependencies found"
          fi

      - name: Update dependencies
        if: steps.outdated.outputs.has_outdated == 'true'
        run: |
          cd app
          echo "Updating dependencies..."
          # Try to upgrade with major versions, but handle SDK conflicts gracefully
          if ! flutter pub upgrade --major-versions; then
            echo "Major version upgrade failed (likely due to SDK version conflicts)"
            echo "Trying minor updates only..."
            if ! flutter pub upgrade; then
              echo "Standard upgrade also failed. This might be due to SDK version constraints."
              echo "Consider updating your Flutter version in the workflow."
              echo "Current Flutter version in workflow: 3.24.0"
              echo "You may need to update to a newer Flutter version to support latest dependencies."
              exit 1
            fi
          fi

      - name: Check for security vulnerabilities
        if: steps.outdated.outputs.has_outdated == 'true'
        run: |
          cd app
          echo "Checking for security vulnerabilities..."
          flutter pub audit --json > audit.json || true

          if [ -s audit.json ]; then
            echo "Security issues found:"
            cat audit.json
          else
            echo "No security issues found"
          fi

      - name: Run tests after update
        if: steps.outdated.outputs.has_outdated == 'true'
        run: |
          cd app
          echo "Running tests to ensure updates don't break anything..."
          flutter pub get
          flutter test

      - name: Run analysis after update
        if: steps.outdated.outputs.has_outdated == 'true'
        run: |
          cd app
          echo "Running code analysis..."
          flutter analyze --no-preamble

      - name: Create Pull Request
        if: steps.outdated.outputs.has_outdated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update Flutter dependencies

            - Updated dependencies to latest versions
            - Verified tests still pass
            - Checked for security vulnerabilities
          title: "chore: Automated Dependency Updates"
          body: |
            ## ðŸ¤– Automated Dependency Updates

            This PR contains automated updates to Flutter dependencies.

            ### Changes Made:
            - Updated dependencies in `pubspec.yaml`
            - Ran tests to ensure compatibility
            - Checked for security vulnerabilities

            ### Files Changed:
            - `app/pubspec.yaml` - Updated dependency versions
            - `app/pubspec.lock` - Updated lock file

            ### Verification:
            âœ… Tests pass
            âœ… Code analysis passes
            âœ… No security vulnerabilities found

            ### SDK Compatibility:
            If you encounter SDK version conflicts (e.g., with `flutter_lints >=6.0.0` requiring Dart SDK ^3.8.0),
            you may need to update the Flutter version in the workflow configuration.

            Current workflow uses: **Flutter 3.24.0** (Dart SDK 3.5.0)

            ---
            *This PR was automatically created by the dependency-updates workflow.*
          branch: automated/dependency-updates
          delete-branch: true
          draft: false
          labels: |
            dependencies
            automated
            chore

      - name: Comment on no updates needed
        if: steps.outdated.outputs.has_outdated == 'false'
        run: |
          echo "No dependency updates needed at this time."