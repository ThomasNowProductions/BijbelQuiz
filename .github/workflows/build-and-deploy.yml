name: Build and Deploy

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Use personal token for pushing changes
          
      - name: Extract version from tag
        id: extract_version
        run: |
          # Extract version from tag (removing 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
      - name: Update pubspec.yaml version
        run: |
          cd app
          # Get current build number from pubspec.yaml
          CURRENT_BUILD=$(grep -oP 'version: \d+\.\d+\.\d+\+?\K\d+' pubspec.yaml)
          
          # Increment build number
          NEW_BUILD=$((CURRENT_BUILD + 1))
          
          # Update version in pubspec.yaml (replace version line)
          sed -i "s/version: \([0-9]*\.[0-9]*\.[0-9]*\)+[0-9]*/version: ${VERSION}+${NEW_BUILD}/" pubspec.yaml
          
          echo "Updated pubspec.yaml version to: $VERSION+$NEW_BUILD"
          echo "Updated pubspec.yaml:"
          grep "version:" pubspec.yaml
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: ${{ runner.tool_cache }}/flutter
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build libgtk-3-dev libblkid-dev liblzma-dev
          
      - name: Make build script executable
        run: chmod +x app/build_all.sh
        
      - name: Run build script
        run: ./app/build_all.sh
        working-directory: ./app
        
      - name: Find latest build directory
        id: find_build
        run: |
          LATEST_BUILD=$(ls -td app/builds/*/ | head -n1)
          echo "LATEST_BUILD=$LATEST_BUILD" >> $GITHUB_OUTPUT
          echo "Found latest build directory: $LATEST_BUILD"
          
      - name: Prepare artifacts for release
        id: prepare_artifacts
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Copy artifacts with appropriate names
          if [ -f "${{ steps.find_build.outputs.LATEST_BUILD }}/bijbelquiz-android.apk" ]; then
            cp "${{ steps.find_build.outputs.LATEST_BUILD }}/bijbelquiz-android.apk" artifacts/android.apk
            echo "android_artifact=android.apk" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "${{ steps.find_build.outputs.LATEST_BUILD }}/bijbelquiz-android.aab" ]; then
            cp "${{ steps.find_build.outputs.LATEST_BUILD }}/bijbelquiz-android.aab" artifacts/android.aab
            echo "android_bundle=bijbelquiz-android.aab" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "${{ steps.find_build.outputs.LATEST_BUILD }}/windows" ]; then
            # Create zip for Windows
            cd "${{ steps.find_build.outputs.LATEST_BUILD }}/windows"
            zip -r "../../../artifacts/windows.zip" ./*
            cd -
            echo "windows_artifact=windows.zip" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "${{ steps.find_build.outputs.LATEST_BUILD }}/linux" ]; then
            # Create zip for Linux
            cd "${{ steps.find_build.outputs.LATEST_BUILD }}/linux"
            zip -r "../../../artifacts/linux.zip" ./*
            cd -
            echo "linux_artifact=linux.zip" >> $GITHUB_OUTPUT
          fi
          
          # For web, we'll handle separately
          if [ -d "${{ steps.find_build.outputs.LATEST_BUILD }}/web" ]; then
            echo "web_available=true" >> $GITHUB_OUTPUT
          fi
          
          # Copy build report
          if [ -f "${{ steps.find_build.outputs.LATEST_BUILD }}/build_report.txt" ]; then
            cp "${{ steps.find_build.outputs.LATEST_BUILD }}/build_report.txt" artifacts/build_report.txt
          fi
          
          ls -la artifacts/
          
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## BijbelQuiz Release ${{ github.ref_name }}
            
            ### Build Information
            - Commit: ${{ github.sha }}
            - Build Time: $(date -u)
            
            ### Included Artifacts
            - Android APK
            - Android App Bundle (AAB)
            - Windows Executable
            - Linux Executable
            - Web Build
            
            For more details, see the build report attached.
            
            Enjoy testing your Bible knowledge!
            
      - name: Upload Android APK to Release
        if: steps.prepare_artifacts.outputs.android_artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/android.apk
          asset_name: bijbelquiz-${{ github.ref_name }}.apk
          asset_content_type: application/vnd.android.package-archive
          
      - name: Upload Android App Bundle to Release
        if: steps.prepare_artifacts.outputs.android_bundle
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/android.aab
          asset_name: bijbelquiz-${{ github.ref_name }}.aab
          asset_content_type: application/octet-stream
          
      - name: Upload Windows ZIP to Release
        if: steps.prepare_artifacts.outputs.windows_artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/windows.zip
          asset_name: bijbelquiz-${{ github.ref_name }}-windows.zip
          asset_content_type: application/zip
          
      - name: Upload Linux ZIP to Release
        if: steps.prepare_artifacts.outputs.linux_artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/linux.zip
          asset_name: bijbelquiz-${{ github.ref_name }}-linux.zip
          asset_content_type: application/zip
          
      - name: Upload Build Report to Release
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/build_report.txt
          asset_name: build_report_${{ github.ref_name }}.txt
          asset_content_type: text/plain
          
      - name: Update website downloads
        run: |
          # Copy built artifacts to website downloads directory
          if [ -f "artifacts/android.apk" ]; then
            cp artifacts/android.apk websites/bijbelquiz.app/downloads/android.apk
            echo "Updated Android APK in downloads"
          fi
          
          if [ -f "artifacts/windows.zip" ]; then
            # For Windows, we'll create a zip file
            cp artifacts/windows.zip websites/bijbelquiz.app/downloads/windows.zip
            echo "Updated Windows files in downloads"
          fi
          
          if [ -f "artifacts/linux.zip" ]; then
            # For Linux, we'll create a zip file
            cp artifacts/linux.zip websites/bijbelquiz.app/downloads/linux.zip
            echo "Updated Linux files in downloads"
          fi
          
          # Display what we've updated
          echo "Downloads directory contents:"
          ls -la websites/bijbelquiz.app/downloads/
          
      - name: Commit and push updates to pubspec.yaml and website changes to main branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add both the pubspec.yaml changes and website updates
          git add app/pubspec.yaml
          git add websites/bijbelquiz.app/downloads/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update pubspec version to ${{ steps.extract_version.outputs.VERSION }} and update downloads [skip ci]"
            
            # Push changes to the main branch (not the tag)
            git push origin main
            
            echo "Pubspec version updated to ${{ steps.extract_version.outputs.VERSION }} and website downloads updated with new release files"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}