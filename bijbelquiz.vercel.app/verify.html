<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activeer BijbelQuiz</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body class="center-screen fade-in">
    <div class="container card">
        <h1>Activeer BijbelQuiz</h1>
        <p>Voer je activatiecode in:</p>
        <input type="text" id="activationCode" placeholder="XXXX-XXXX-XXXX" autocomplete="one-time-code" inputmode="text">
        <button id="verifyBtn" class="btn primary">Verifieer Code</button>
        <div id="message" class="text-center" aria-live="polite"></div>
    </div>

    <script>
        // Activation API (hardcoded codes served by backend)
        const API_URL = 'https://backendbijbelquiz.vercel.app/api/activation-codes.php';

        function isActivated() {
            try {
                if (localStorage.getItem('bq_activation')) return true;
            } catch (e) {}
            return document.cookie.split('; ').some(c => c.startsWith('bq_activation=1'));
        }

        function setActivated(code) {
            try {
                localStorage.setItem('bq_activation', JSON.stringify({ code, at: Date.now() }));
            } catch (e) {}
            document.cookie = 'bq_activation=1; Max-Age=31536000; Path=/; SameSite=Lax';
        }

        function getRedirectTarget() {
            const p = new URLSearchParams(location.search);
            const to = p.get('redirect') || 'download.html';
            const apk = p.get('apk');
            return apk ? `${to}?apk=${encodeURIComponent(apk)}` : to;
        }

        async function verifyCode() {
            const input = document.getElementById('activationCode');
            const btn = document.getElementById('verifyBtn');
            const msg = document.getElementById('message');
            const code = (input.value || '').trim().toUpperCase();

            msg.textContent = '';
            if (!code) {
                msg.textContent = 'Voer een code in.';
                msg.style.color = 'var(--tertiary)';
                input.focus();
                return;
            }

            btn.disabled = true;
            btn.style.opacity = '0.8';

            try {
                const res = await fetch(`${API_URL}?code=${encodeURIComponent(code)}`, { method: 'GET' });
                const data = await res.json();
                if (data && data.valid === true) {
                    msg.textContent = 'Code geaccepteerd! Doorverwijzen...';
                    msg.style.color = 'var(--success)';
                    setActivated(code);
                    setTimeout(() => {
                        location.replace(getRedirectTarget());
                    }, 600);
                } else {
                    msg.textContent = 'Ongeldige code. Probeer het opnieuw.';
                    msg.style.color = 'var(--error)';
                }
            } catch (e) {
                msg.textContent = 'Netwerkfout. Probeer later opnieuw.';
                msg.style.color = 'var(--error)';
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        document.getElementById('verifyBtn').addEventListener('click', verifyCode);
        document.getElementById('activationCode').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') verifyCode();
        });

        // If already activated, go directly to the target
        if (isActivated()) {
            location.replace(getRedirectTarget());
        }
    </script>
</body>
</html>
